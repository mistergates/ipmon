{% extends "layout.html" %}

{% block content %}

<div class="container has-text-centered">
  <nav class="level">
    <div class="level-item">
      <div>
        <p class="heading">Total Hosts</p>
        <p class="title has-text-primary" id="total-hosts"></p>
      </div>
    </div>
    <div class="level-item has-text-centered">
      <div>
        <p class="heading">Available Hosts</p>
        <p class="title has-text-success" id="available-hosts"></p>
      </div>
    </div>
    <div class="level-item has-text-centered">
      <div>
        <p class="heading">Unavailable Hosts</p>
        <p class="title has-text-danger" id="unavailable-hosts"></p>
      </div>
    </div>
  </nav>
</div>

<section class="hero-body" id="expand-me">
  <div class="container">
    <button class="button is-small is-outlined is-pulled-right" id="expand">
      <span class="icon is-small">
        <i class="fa fa-expand-arrows-alt" id="expander"></i>
      </span>
    </button>
    <table class="table is-fullwidth is-hoverable is-striped" id="ip-status">
      <!-- Data Table -->
    </table>
  </div>
</section>

<script>
  // Update Datatable - Called on interval
  async function updateTable() {
    await $.ajax({
      url: '/getHosts',
      type: 'GET',
      success: function (response) {
        var json_data = JSON.parse(response)
        var json = {
          "columns": [
            { "data": "hostname", "title": "Hostname" },
            { "data": "ip_address", "title": "IP Address" },
            { "data": "last_poll", "title": "Last Poll" },
            { "data": "status", "title": "Status" }
          ],
          "data": json_data
        }

        if ($.fn.DataTable.isDataTable('#ip-status')) {
          $('#ip-status').DataTable().destroy();
        }

        var table = $('#ip-status').DataTable({
          "order": [[3, "asc"]],
          data: json.data,
          columns: json.columns,
          paging: false,
          searching: false,
          'rowCallback': function (row, data, index) {
            var status_col = $(row).find('td:eq(3)')
            var last_poll_col = $(row).find('td:eq(2)')
            var host = data['hostname']

            // Change status row to use up/down circles and status colors
            status_col.empty();
            if (data['status'] == 'Down') {
              status_col.append('<i class="fas fa-arrow-circle-down"></i>');
              $(row).addClass('has-background-danger has-text-white');
            } else {
              status_col.addClass("has-text-success");
              status_col.append('<i class="fas fa-arrow-circle-up"></i>');
            }

            // Add link to last poll and event listener for loading poll history in modal
            last_poll_col.append('<span class="icon"><i class="fa fa-history"></i></span>')
            last_poll_col.click(function () {
              load_poll_history(data['hostname'], data['id']);
            });
          }
        })
      }
    });
  }

  async function updateHostCounts() {
    await $.ajax({
      url: '/getHostCounts',
      type: 'GET',
      success: function (response) {
        var json_data = JSON.parse(response)
        $("#total-hosts").text(json_data['total_hosts'])
        $("#available-hosts").text(json_data['available_hosts'])
        $("#unavailable-hosts").text(json_data['unavailable_hosts'])
      }
    })
  }

  // Load Polling History for Host
  async function load_poll_history(hostname, id) {
    await clear_modal();
    await add_modal_content(hostname, '<div class="table-container"><table class="table is-fullwidth is-hoverable is-striped" id="modal-table" ></table></div>', 'Poll History');
    await $.ajax({
      url: '/getPollHistory/' + id,
      type: 'GET',
      success: function (response) {
        var json_data = JSON.parse(response)
        var json = {
          "columns": [
            { "data": "poll_time", "title": "Poll Time" },
            { "data": "poll_status", "title": "Poll Status" },
          ],
          "data": json_data
        }
        $('#modal-table').DataTable({
          "order": [[0, "desc"]],
          data: json.data,
          columns: json.columns,
          paging: true
        });
      }
    });
    await show_modal();
  }

  // Fullscreen Toggle
  function fullscreenToggle() {
    var section = $("#expand-me")
    var expander = $("#expander")

    if (section.hasClass('fullscreen') == true) {
      section.removeClass('fullscreen')
      expander.removeClass("fa fa-compress-arrows-alt")
      expander.addClass("fa fa-expand-arrows-alt")
    } else {
      section.addClass('fullscreen')
      expander.removeClass("fa fa-expand-arrows-alt")
      expander.addClass("fa fa-compress-arrows-alt")
    }
  }

  // Show progress bar until datatable loads
  // Update datatable at interval of {{ poll_interval }} seconds
  $(document).ready(function () {
    updateTable();
    updateHostCounts();
    setInterval(updateTable, {{ poll_interval }});
    setInterval(updateHostCounts, {{ poll_interval }});

    // Expand body listener
    $("#expand").click(function () {
      fullscreenToggle();
    })
  });

</script>

{% endblock %}